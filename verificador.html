<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Acceso v3 - Optimizado</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; text-align: center; }
        #reader { width: 300px; margin: 20px auto; border: 2px solid #ccc; }
        #result-container { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: left; }
        .result-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .result-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        h2 { margin-top: 0; }
        p { margin: 5px 0; }
        strong { color: #333; }
        #start-scan-btn { padding: 15px 30px; font-size: 18px; cursor: pointer; background-color: #28a745; color: white; border: none; border-radius: 5px; }
        #loading-spinner { display: none; margin-top: 20px; }
    </style>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
    <h1>Verificador de Acceso con Revocación</h1>
    <p>Presione el botón y apunte la cámara al código QR.</p>
    <button id="start-scan-btn">Iniciar Escáner</button>
    <div id="reader" style="display:none;"></div>
    <div id="loading-spinner">Verificando estado...</div>
    <div id="result-container"></div>
    <script>
        const REVOCATION_LIST_URL = 'URL_DE_TU_GIST_RAW_AQUÍ'; // <-- RECUERDA PONER TU URL

        const resultContainer = document.getElementById('result-container');
        const startScanBtn = document.getElementById('start-scan-btn');
        const readerDiv = document.getElementById('reader');
        const loadingSpinner = document.getElementById('loading-spinner');
        let html5QrcodeScanner;

        function stopScanner() {
            if (html5QrcodeScanner && html5QrcodeScanner.getState() === 2) {
                html5QrcodeScanner.clear().catch(error => console.error("Fallo al detener.", error));
            }
            readerDiv.style.display = 'none';
            startScanBtn.style.display = 'block';
            loadingSpinner.style.display = 'none';
        }

        async function onScanSuccess(decodedText, decodedResult) {
            loadingSpinner.style.display = 'block';
            stopScanner();

            try {
                const data = JSON.parse(decodedText);

                // Verificamos usando las claves cortas
                if (!data.n || !data.id || !data.e || !data.v) {
                    throw new Error("El código QR no contiene datos de acceso válidos.");
                }

                const response = await fetch(REVOCATION_LIST_URL + '?t=' + new Date().getTime());
                if (!response.ok) {
                    throw new Error("No se pudo conectar al servicio de verificación de estado.");
                }
                const revokedIds = await response.json();

                if (revokedIds.includes(data.id)) {
                    resultContainer.className = 'result-error';
                    resultContainer.innerHTML = `
                        <h2>❌ ACCESO DENEGADO (REVOCADO)</h2>
                        <p>El acceso para esta persona ha sido revocado.</p><hr>
                        <p><strong>Nombre:</strong> ${data.n}</p>
                        <p><strong>Identificación:</strong> ${data.id}</p>
                    `;
                } else if (data.e === "A") { // Verificamos si el estado es "A" (Autorizado)
                    resultContainer.className = 'result-success';
                    resultContainer.innerHTML = `
                        <h2>✅ ACCESO PERMITIDO</h2>
                        <p><strong>Nombre:</strong> ${data.n}</p>
                        <p><strong>Identificación:</strong> ${data.id}</p><hr>
                        <p><strong>Vehículo:</strong> ${data.v.t}</p>
                        <p><strong>Modelo:</strong> ${data.v.m}</p>
                        <p><strong>Placa:</strong> ${data.v.p}</p><hr>
                        <p><small>Código generado el: ${data.f || 'N/A'}</small></p>
                    `;
                } else {
                    throw new Error("Estado de acceso no válido en el QR.");
                }

            } catch (e) {
                resultContainer.className = 'result-error';
                resultContainer.innerHTML = `<h2>❌ ACCESO DENEGADO</h2><p><strong>Error:</strong> ${e.message}</p>`;
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function onScanFailure(error) {}
        
        startScanBtn.addEventListener('click', () => {
            resultContainer.innerHTML = '';
            startScanBtn.style.display = 'none';
            readerDiv.style.display = 'block';
            html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        });
    </script>
</body>
</html>
</body>
</html>