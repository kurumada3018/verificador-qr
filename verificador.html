<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Acceso (MODO DEPURACI√ìN)</title>
    <!-- Estilos (sin cambios) -->
    <style>body{font-family:sans-serif;max-width:600px;margin:20px auto;text-align:center}#reader{width:300px;margin:20px auto;border:2px solid #ccc}#result-container{margin-top:20px;padding:15px;border-radius:8px;text-align:left}.result-success{background-color:#d4edda;color:#155724;border:1px solid #c3e6cb}.result-error{background-color:#f8d7da;color:#721c24;border:1px solid #f5c6cb}h2{margin-top:0}p{margin:5px 0}#audit-info{font-style:italic;color:#666;font-size:.9em}#start-scan-btn{padding:15px 30px;font-size:18px;cursor:pointer;background-color:#28a745;color:white;border:none;border-radius:5px}</style>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
    <h1>Verificador de Acceso con Auditor√≠a</h1>
    <p>Presione el bot√≥n y apunte la c√°mara al c√≥digo QR.</p>
    <button id="start-scan-btn">Iniciar Esc√°ner</button>
    <div id="reader" style="display:none;"></div>
    <div id="result-container"></div>

    <script>
        // <-- üî¥ ¬°MUY IMPORTANTE! ASEG√öRATE DE QUE ESTA URL SEA LA CORRECTA
        const REVOCATION_LIST_URL = 'https://gist.githubusercontent.com/kurumada3018/383b3a95a70bce63100bbe4149442fc3/raw/beac26438655e38a21b32db55b5444eb5fe585fd/lista_revocados.json';

        const resultContainer = document.getElementById('result-container');
        const startScanBtn = document.getElementById('start-scan-btn');
        const readerDiv = document.getElementById('reader');
        let html5QrcodeScanner;

        function stopScanner() { if (html5QrcodeScanner && html5QrcodeScanner.getState() === 2) { html5QrcodeScanner.clear().catch(error => console.error("Fallo al detener.", error)); } readerDiv.style.display = 'none'; startScanBtn.style.display = 'block'; }

        async function onScanSuccess(decodedText, decodedResult) {
            stopScanner();
            console.clear(); // Limpia la consola para cada nuevo escaneo
            console.log("--- INICIANDO VERIFICACI√ìN ---");

            try {
                const data = JSON.parse(decodedText);

                // --- L√çNEAS DE DEPURACI√ìN ---
                console.log("1. Datos extra√≠dos del QR:", data);
                console.log("2. ID a verificar:", data.id, "(Tipo:", typeof data.id, ")");

                const response = await fetch(REVOCATION_LIST_URL + '?t=' + new Date().getTime());
                if (!response.ok) throw new Error("No se pudo conectar al servicio de revocaci√≥n.");
                const revokedIds = await response.json();

                // --- M√ÅS L√çNEAS DE DEPURACI√ìN ---
                console.log("3. Lista de revocados descargada de GitHub:", revokedIds);
                console.log("4. ¬øEl ID del QR est√° en la lista de revocados?", revokedIds.includes(data.id));
                console.log("--- FIN DE VERIFICACI√ìN ---");


                if (revokedIds.includes(data.id)) {
                    resultContainer.className = 'result-error';
                    resultContainer.innerHTML = `<h2>‚ùå ACCESO DENEGADO (REVOCADO)</h2><p><strong>Nombre:</strong> ${data.n}</p><p><strong>Identificaci√≥n:</strong> ${data.id}</p>`;
                } else if (data.e === "A") {
                    resultContainer.className = 'result-success';
                    resultContainer.innerHTML = `<h2>‚úÖ ACCESO PERMITIDO</h2><p><strong>Nombre:</strong> ${data.n}</p><p><strong>Identificaci√≥n:</strong> ${data.id}</p><hr><p><strong>Veh√≠culo:</strong> ${data.v.t}</p><p><strong>Modelo:</strong> ${data.v.m}</p><p><strong>Placa:</strong> ${data.v.p}</p><hr><p id="audit-info">Generado el: ${data.f || 'N/A'} por <strong>${data.c || 'Desconocido'}</strong></p>`;
                } else {
                    throw new Error("Estado de acceso no v√°lido.");
                }

            } catch (e) {
                resultContainer.className = 'result-error';
                resultContainer.innerHTML = `<h2>‚ùå ACCESO DENEGADO</h2><p><strong>Error:</strong> ${e.message}</p>`;
                console.error("Error durante el proceso:", e);
            }
        }

        function onScanFailure(error) {}
        
        startScanBtn.addEventListener('click', () => {
            resultContainer.innerHTML = '';
            startScanBtn.style.display = 'none';
            readerDiv.style.display = 'block';
            html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        });
    </script>
</body>
</html>
